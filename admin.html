<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Previsualización en Tiempo Real</title>
    <style>
        /* Diseño inspirado en Apple para admin: minimalista, glassmorphism, igual que index */
        @font-face {
            font-family: 'SF Pro';
            src: url('https://fonts.cdnfonts.com/css/sf-pro-display') format('woff2');
        }

        body {
            font-family: 'SF Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f7;
            color: #1d1d1f;
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .login-section {
            margin-left: auto;
        }

        .hidden {
            display: none;
        }

        main {
            margin-top: 60px;
            padding: 20px;
        }

        section {
            margin: 40px 0;
            padding: 40px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 18px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            min-height: 300px;
        }

        section h2 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .edit-tools {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }

        .add-btn {
            background: #0071e3;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }

        .save-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .contenido-container {
            position: relative;
            min-height: 200px;
        }

        .draggable {
            position: absolute;
            cursor: move;
            user-select: none;
            border: 1px dashed #0071e3; /* Para indicar editable */
            padding: 5px;
            background: rgba(255, 255, 255, 0.8);
            transition: box-shadow 0.3s ease;
        }

        .draggable:hover {
            box-shadow: 0 2px 10px rgba(0, 113, 227, 0.3);
        }

        .draggable img {
            max-width: 100%;
            height: auto;
        }

        .draggable p {
            margin: 0;
        }

        /* Otras secciones como en index */
        #mantenimiento-banner {
            background: #ffcc00;
            text-align: center;
            padding: 15px;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(255, 204, 0, 0.2);
        }

        #banner {
            text-align: center;
            margin: 20px 0;
            padding: 0 20px;
        }

        #banner-img {
            max-width: 100%;
            border-radius: 18px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        footer {
            padding: 40px 20px;
            background: rgba(245, 245, 247, 0.9);
            backdrop-filter: blur(10px);
            text-align: center;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
</head>
<body>
    <header>
        <h1>Panel de Administración - Previsualización</h1>
        <div class="login-section">
            <button id="login-btn">Iniciar Sesión</button>
            <div id="login-form" class="hidden">
                <input type="email" id="email" placeholder="Email">
                <input type="password" id="password" placeholder="Contraseña">
                <button id="submit-login">Entrar con Email</button>
                <button id="google-login">Iniciar Sesión con Google</button>
                <button id="apple-login">Iniciar Sesión con Apple</button>
            </div>
            <button id="logout-btn" class="hidden">Cerrar Sesión</button>
        </div>
    </header>

    <main id="admin-content" class="hidden">
        <!-- Banner de Mantenimiento -->
        <section id="mantenimiento-section">
            <h2>Banner de Mantenimiento</h2>
            <label>
                <input type="checkbox" id="mantenimiento-toggle"> Activar
            </label>
            <button id="save-mantenimiento">Guardar</button>
        </section>

        <!-- Banner con Imagen -->
        <section id="banner-section">
            <h2>Banner con Imagen</h2>
            <input type="text" id="banner-imagen-input" placeholder="URL de la Imagen">
            <button id="save-banner">Guardar</button>
        </section>

        <!-- Título Principal -->
        <section id="titulo-principal-section">
            <h2>Título Principal</h2>
            <input type="text" id="titulo-principal-input" placeholder="Título Principal">
            <button id="save-titulo-principal">Guardar</button>
        </section>

        <!-- Secciones con Previsualización Editable -->
        <section id="seccion1">
            <h2 id="titulo-seccion1">Cargando Sección 1...</h2>
            <div class="edit-tools">
                <button class="add-btn" data-seccion="1">Agregar Contenido</button>
                <button class="save-btn" data-seccion="1">Guardar Sección 1</button>
            </div>
            <div id="contenido-seccion1" class="contenido-container"></div>
        </section>

        <section id="seccion2">
            <h2 id="titulo-seccion2">Cargando Sección 2...</h2>
            <div class="edit-tools">
                <button class="add-btn" data-seccion="2">Agregar Contenido</button>
                <button class="save-btn" data-seccion="2">Guardar Sección 2</button>
            </div>
            <div id="contenido-seccion2" class="contenido-container"></div>
        </section>

        <section id="seccion3">
            <h2 id="titulo-seccion3">Cargando Sección 3...</h2>
            <div class="edit-tools">
                <button class="add-btn" data-seccion="3">Agregar Contenido</button>
                <button class="save-btn" data-seccion="3">Guardar Sección 3</button>
            </div>
            <div id="contenido-seccion3" class="contenido-container"></div>
        </section>

        <!-- Atajos -->
        <section id="atajos-section">
            <h2>Atajos (Máximo 6)</h2>
            <div id="atajos-list">
                <!-- Atajos dinámicos -->
            </div>
            <button id="add-atajo">Agregar Atajo</button>
            <button id="save-atajos">Guardar Atajos</button>
        </section>

        <!-- Redes Sociales -->
        <section id="redes-section">
            <h2>Redes Sociales</h2>
            <div id="redes-list">
                <!-- Redes dinámicas -->
            </div>
            <button id="save-redes">Guardar Redes</button>
        </section>
    </main>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-analytics.js";
        import { getDatabase, ref as dbRef, get, set, push, remove } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, OAuthProvider } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCSu34Ls6HzmX1ANI19KPzttAKTqf5bDxY",
          authDomain: "tuwebyaa-da5a4.firebaseapp.com",
          projectId: "tuwebyaa-da5a4",
          storageBucket: "tuwebyaa-da5a4.appspot.com",
          messagingSenderId: "978686266841",
          appId: "1:978686266841:web:33ffcb2ff2965589151dc8",
          measurementId: "G-X1FY1MR0M7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        const adminContent = document.getElementById('admin-content');
        const loginBtn = document.getElementById('login-btn');
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const submitLogin = document.getElementById('submit-login');
        const googleLogin = document.getElementById('google-login');
        const appleLogin = document.getElementById('apple-login');
        const logoutBtn = document.getElementById('logout-btn');

        // Monitorear estado de autenticación
        onAuthStateChanged(auth, (user) => {
            if (user && user.email === 'fernando8aparra@gmail.com') {
                adminContent.classList.remove('hidden');
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                loadAdminData();
            } else {
                adminContent.classList.add('hidden');
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                if (user) {
                    signOut(auth);
                    alert('Acceso denegado. Solo fernando8aparra@gmail.com es admin.');
                }
            }
        });

        loginBtn.addEventListener('click', () => {
            loginForm.classList.toggle('hidden');
        });

        submitLogin.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            signInWithEmailAndPassword(auth, email, password)
                .then(userCredential => {
                    console.log('Admin logueado con email');
                    loginForm.classList.add('hidden');
                })
                .catch(error => console.error('Error en login con email:', error));
        });

        googleLogin.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then(userCredential => {
                    console.log('Admin logueado con Google');
                    loginForm.classList.add('hidden');
                })
                .catch(error => console.error('Error en login con Google:', error));
        });

        appleLogin.addEventListener('click', () => {
            const provider = new OAuthProvider('apple.com');
            provider.addScope('email name');
            signInWithPopup(auth, provider)
                .then(userCredential => {
                    console.log('Admin logueado con Apple');
                    loginForm.classList.add('hidden');
                })
                .catch(error => console.error('Error en login con Apple:', error));
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                console.log('Sesión cerrada');
            }).catch(error => console.error('Error en logout:', error));
        });

        // Cargar datos iniciales y renderizar previsualización
        async function loadAdminData() {
            // Título Principal
            get(dbRef(db, 'config/titulo_principal')).then(snapshot => {
                document.getElementById('titulo-principal-input').value = snapshot.val() || '';
            });

            // Secciones con previsualización
            ['1', '2', '3'].forEach(async num => {
                get(dbRef(db, `config/seccion${num}/titulo`)).then(snapshot => {
                    document.getElementById(`titulo-seccion${num}`).textContent = snapshot.val() || `Sección ${num}`;
                });

                get(dbRef(db, `config/seccion${num}/contenido`)).then(snapshot => {
                    const contenido = snapshot.val() || [];
                    const contDiv = document.getElementById(`contenido-seccion${num}`);
                    contDiv.innerHTML = '';
                    contenido.forEach(item => {
                        addElementToPreview(contDiv, item);
                    });
                });
            });

            // Atajos
            get(dbRef(db, 'config/atajos')).then(snapshot => {
                const atajos = snapshot.val() || [];
                const atajosList = document.getElementById('atajos-list');
                atajosList.innerHTML = '';
                atajos.forEach((atajo, index) => {
                    addAtajoItem(atajosList, index, atajo);
                });
            });

            // Redes Sociales
            const redes = ['instagram', 'facebook', 'youtube', 'x'];
            const redesList = document.getElementById('redes-list');
            redesList.innerHTML = '';
            redes.forEach(async red => {
                get(dbRef(db, `config/redes/${red}`)).then(snapshot => {
                    const config = snapshot.val() || { on: false, link: '', usuario: '' };
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <h3>${red.charAt(0).toUpperCase() + red.slice(1)}</h3>
                        <label><input type="checkbox" class="red-on" data-red="${red}" ${config.on ? 'checked' : ''}> Activar</label>
                        <input type="text" class="red-link" data-red="${red}" placeholder="Link" value="${config.link || ''}">
                        <input type="text" class="red-usuario" data-red="${red}" placeholder="Usuario" value="${config.usuario || ''}">
                    `;
                    redesList.appendChild(div);
                });
            });

            // Mantenimiento
            get(dbRef(db, 'config/mantenimiento')).then(snapshot => {
                document.getElementById('mantenimiento-toggle').checked = !!snapshot.val();
            });

            // Banner Imagen
            get(dbRef(db, 'config/banner/imagen')).then(snapshot => {
                document.getElementById('banner-imagen-input').value = snapshot.val() || '';
            });
        }

        // Guardar Título Principal
        document.getElementById('save-titulo-principal').addEventListener('click', () => {
            const titulo = document.getElementById('titulo-principal-input').value;
            set(dbRef(db, 'config/titulo_principal'), titulo).then(() => console.log('Título guardado'));
        });

        // Agregar Contenido (texto o imagen)
        document.querySelectorAll('.add-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const num = btn.dataset.seccion;
                const type = prompt('Elige tipo: "text" o "image"');
                if (type === 'text') {
                    const value = prompt('Ingresa el texto:');
                    if (value) {
                        const item = { type: 'text', value, style: { font: 'SF Pro', position: 'absolute', left: '0px', top: '0px', width: 'auto', height: 'auto' } };
                        addElementToPreview(document.getElementById(`contenido-seccion${num}`), item);
                    }
                } else if (type === 'image') {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const storageReference = storageRef(storage, 'images/' + file.name);
                            await uploadBytes(storageReference, file);
                            const url = await getDownloadURL(storageReference);
                            const item = { type: 'image', value: url, style: { position: 'absolute', left: '0px', top: '0px', width: '200px', height: 'auto' } };
                            addElementToPreview(document.getElementById(`contenido-seccion${num}`), item);
                        }
                    };
                    input.click();
                }
            });
        });

        // Función para agregar elemento a previsualización y hacerlo draggable/resizable
        function addElementToPreview(contDiv, item) {
            let elem;
            if (item.type === 'text') {
                elem = document.createElement('p');
                elem.textContent = item.value;
                elem.classList.add('draggable');
                elem.style.fontFamily = item.style.font;
                elem.style.position = item.style.position;
                elem.style.left = item.style.left;
                elem.style.top = item.style.top;
                elem.style.width = item.style.width;
                elem.style.height = item.style.height;
                elem.style.margin = '0';
                elem.style.padding = '5px';
                elem.style.background = 'transparent';
            } else if (item.type === 'image') {
                elem = document.createElement('div'); // Contenedor para resize
                elem.classList.add('draggable');
                const img = document.createElement('img');
                img.src = item.value;
                img.style.width = '100%';
                img.style.height = '100%';
                elem.appendChild(img);
                elem.style.position = item.style.position;
                elem.style.left = item.style.left;
                elem.style.top = item.style.top;
                elem.style.width = item.style.width;
                elem.style.height = item.style.height;
            }
            contDiv.appendChild(elem);

            // Hacer draggable y resizable
            interact(elem)
                .draggable({
                    listeners: {
                        move(event) {
                            const target = event.target;
                            const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                            const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                            target.style.left = `${x}px`;
                            target.style.top = `${y}px`;
                            target.setAttribute('data-x', x);
                            target.setAttribute('data-y', y);
                        }
                    }
                })
                .resizable({
                    edges: { left: true, right: true, bottom: true, top: true },
                    listeners: {
                        move(event) {
                            const target = event.target;
                            let x = parseFloat(target.getAttribute('data-x')) || 0;
                            let y = parseFloat(target.getAttribute('data-y')) || 0;
                            target.style.width = `${event.rect.width}px`;
                            target.style.height = `${event.rect.height}px`;
                            x += event.deltaRect.left;
                            y += event.deltaRect.top;
                            target.style.left = `${x}px`;
                            target.style.top = `${y}px`;
                            target.setAttribute('data-x', x);
                            target.setAttribute('data-y', y);
                        }
                    }
                });
        }

        // Guardar Secciones (extraer posiciones y guardar en Firebase)
        document.querySelectorAll('.save-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const num = btn.dataset.seccion;
                const contDiv = document.getElementById(`contenido-seccion${num}`);
                const contenidos = [];
                contDiv.querySelectorAll('.draggable').forEach(elem => {
                    const type = elem.tagName === 'P' ? 'text' : 'image';
                    const value = type === 'text' ? elem.textContent : elem.querySelector('img').src;
                    const style = {
                        font: elem.style.fontFamily,
                        position: elem.style.position,
                        left: elem.style.left,
                        top: elem.style.top,
                        width: elem.style.width,
                        height: elem.style.height
                    };
                    contenidos.push({ type, value, style });
                });
                set(dbRef(db, `config/seccion${num}/contenido`), contenidos).then(() => console.log(`Sección ${num} guardada`));
            });
        });

        // Guardar Mantenimiento
        document.getElementById('save-mantenimiento').addEventListener('click', () => {
            const on = document.getElementById('mantenimiento-toggle').checked;
            set(dbRef(db, 'config/mantenimiento'), on).then(() => console.log('Mantenimiento guardado'));
        });

        // Guardar Banner
        document.getElementById('save-banner').addEventListener('click', () => {
            const imgUrl = document.getElementById('banner-imagen-input').value;
            set(dbRef(db, 'config/banner/imagen'), imgUrl).then(() => console.log('Banner guardado'));
        });

        // Nota: Para atajos y redes, mantener como antes. El admin ahora es una previsualización editable de las secciones.
    </script>
</body>
</html>
